{% extends "base.html" %}
{% load static i18n %}

{% block title %}{{ product.name }} - BloomBerry{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/product_detail.css' %}">
{% endblock %}

{% block content %}
<div class="bb-main">
  <div class="bb-product-detail">
    
    <!-- Imagen -->
    <div class="bb-product-image">
      {% if product.image %}
        <img src="{{ product.image.url }}" alt="{{ product.name }}">
      {% else %}
        <img src="{% static 'img/no-image.png' %}" alt="{% trans 'Sin imagen' %}">
      {% endif %}
    </div>

    <!-- Info del producto -->
    <div class="bb-product-info">
      <h1>{{ product.name }}</h1>
      <p class="description">{{ product.description }}</p>
      <p class="price">${{ product.price|floatformat:0 }}</p>

      <div class="bb-actions">
        <!-- Botón añadir al carrito -->
        <form method="post" action="{% url 'orders:add_to_cart' product.id %}">
          {% csrf_token %}
          <button type="submit" class="bb-btn primary">
            {% trans "Añadir al carrito" %}
          </button>
        </form>

        <!-- Botón wishlist -->
        <form method="post" action="{% url 'products:add_to_wishlist' product.id %}" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="wishlist_name" value="Favoritos">
          <button type="submit" class="bb-btn secondary">
            {% if in_wishlist %}
              {% trans "En tus favoritos" %}
            {% else %}
              {% trans "Agregar a favoritos" %}
            {% endif %}
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Mensajes de feedback -->
  {% if messages %}
    <ul class="messages">
      {% for message in messages %}
        <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- Reseñas -->
  <section class="bb-reviews">
    <h2>
      {% trans "Reseñas" %} ({{ product.quantity_of_reviews }}) — 
      {% trans "Promedio" %}: {{ product.avg_rating }}
    </h2>

    {% for review in reviews %}
      <div class="bb-review">
        <strong>{{ review.user.username }}</strong>
        <span class="rating">{{ review.rating }} / 5</span>
        <p>{{ review.comment|linebreaks }}</p>
        <small>{{ review.created_at|date:"SHORT_DATETIME_FORMAT" }}</small>
      </div>
    {% empty %}
      <p>{% trans "Aún no hay reseñas para este producto." %}</p>
    {% endfor %}
  </section>

  <!-- Formulario para dejar reseña -->
  <section class="bb-leave-review">
    <h3>{% trans "Deja tu reseña" %}</h3>

    {% if user.is_authenticated %}
      <form method="post" action="{% url 'products:add_review' product.id %}">
        {% csrf_token %}
        {{ review_form.non_field_errors }}

        <div class="form-row">
          <label for="{{ review_form.rating.id_for_label }}">{{ review_form.rating.label }}</label>
          {{ review_form.rating }}
        </div>

        <div class="form-row">
          <label for="{{ review_form.comment.id_for_label }}">{{ review_form.comment.label }}</label>
          {{ review_form.comment }}
        </div>

        <button type="submit" class="bb-btn primary">
          {% trans "Enviar reseña" %}
        </button>
      </form>
    {% else %}
      <p>
        {% trans "Debes" %} 
        <a href="{% url 'login' %}?next={{ request.path }}">
          {% trans "iniciar sesión" %}
        </a> 
        {% trans "para dejar una reseña." %}
      </p>
    {% endif %}
  </section>
</div>
{% endblock %}
