<!--
Autor: Maria Clara Medina Gomez
Proyecto: BloomBerry
Archivo: templates/chat/widget.html
DescripciÃ³n: Layout del widget del chatbot del sitio 
-->

{% load static %}

<!-- Hoja de estilos del widget -->
<link rel="stylesheet" href="{% static 'css/widget.css' %}?v=3">

<!-- FAB (botÃ³n flotante con tu imagen) -->
<button id="bb-fab" aria-label="Abrir chat">
  <img src="{% static 'img/chatbot.png' %}" alt="Chat BloomBerry">
</button>

<!-- Panel del chat -->
<div id="bb-panel" role="dialog" aria-label="Chat BloomBerry" aria-modal="false">
  <div id="bb-header">
    <strong>Asistente BloomBerry</strong>
    <button id="bb-close" aria-label="Cerrar">Ã—</button>
  </div>

  <div id="bb-log"></div>

  <form id="bb-form" action="{% url 'chat:send_message' %}" method="post">
    {% csrf_token %}
    <input id="bb-input" type="text" name="message" placeholder="Escribe tu dudaâ€¦" autocomplete="off">
    <button id="bb-send" type="submit">Enviar</button>
  </form>
</div>

<script>
(function(){
  const BB_CHAT_GREETING = "Â¡Hola! Soy tu asistente virtual de BloomBerry ðŸ˜Š. Puedo ayudarte con productos de cuidado facial, maquillaje, medicamentos naturales, esencias y suplementos diarios. Â¿QuÃ© estÃ¡s buscando hoy?";

  const fab     = document.getElementById("bb-fab");
  const panel   = document.getElementById("bb-panel");
  const log     = document.getElementById("bb-log");
  const form    = document.getElementById("bb-form");
  const input   = document.getElementById("bb-input");
  const closeBtn= document.getElementById("bb-close");
  const sendBtn = document.getElementById("bb-send");

  /* ---------- UI ---------- */
  function togglePanel(show){ 
    panel.style.display = show ? "flex" : "none"; 
    if (show) initGreetingIfNeeded();
  }
  fab.addEventListener("click", ()=> togglePanel(panel.style.display !== "flex"));
  closeBtn.addEventListener("click", ()=> togglePanel(false));

  function getCookie(name){
    const v=`; ${document.cookie}`; const p=v.split(`; ${name}=`);
    if(p.length===2) return p.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  function addBubble(text, who){
    const b = document.createElement("div");
    b.className = "bb-bubble " + (who === "user" ? "bb-user" : "bb-assistant");
    if (who !== "user"){
      const meta = document.createElement("div");
      meta.className = "bb-meta"; meta.textContent = "Asistente";
      b.appendChild(meta);
    }
    const body = document.createElement("div");
    body.textContent = text;
    b.appendChild(body);
    log.appendChild(b);
    log.scrollTop = log.scrollHeight;
    return b;
  }

  function addTyping(){
    const b = document.createElement("div");
    b.className = "bb-bubble bb-assistant";
    const meta = document.createElement("div");
    meta.className = "bb-meta"; meta.textContent = "Asistente";
    const dots = document.createElement("div");
    dots.className = "bb-typing";
    dots.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
    b.appendChild(meta); b.appendChild(dots);
    log.appendChild(b);
    log.scrollTop = log.scrollHeight;
    return b;
  }

  function initGreetingIfNeeded(){
    if (!log.querySelector('[data-greeting]')) {
      const b = document.createElement("div");
      b.className = "bb-bubble bb-assistant";
      b.setAttribute("data-greeting","true");
      const meta = document.createElement("div");
      meta.className = "bb-meta"; meta.textContent = "Asistente";
      const body = document.createElement("div");
      body.textContent = BB_CHAT_GREETING;
      b.appendChild(meta); b.appendChild(body);
      log.appendChild(b);
      log.scrollTop = log.scrollHeight;
    }
  }

  /* ---------- EnvÃ­o al backend ---------- */
  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const text = (input.value || "").trim();
    if(!text) return;
    addBubble(text, "user");
    input.value = "";
    input.disabled = true; sendBtn.disabled = true;

    const typing = addTyping();

    try{
      const resp = await fetch(form.action, {
        method: "POST",
        headers: {"X-CSRFToken": csrftoken, "X-Requested-With": "XMLHttpRequest"},
        body: new URLSearchParams({message: text})
      });

      typing.remove();

      if (!resp.ok){
        const txt = await resp.text();
        addBubble(`Error ${resp.status}: ${txt.slice(0,200)}`, "assistant");
        return;
      }

      const data = await resp.json();
      if (data && data.ok){
        const b = addBubble(data.reply || "", "assistant");
        if (Array.isArray(data.products) && data.products.length){
          const wrap = document.createElement("div");
          wrap.className = "bb-products";
          for (const p of data.products){
            const a = document.createElement("a");
            a.className = "bb-chip";
            a.href = p.url || "#";
            a.textContent = p.name + (p.price ? ` ($${p.price})` : "");
            wrap.appendChild(a);
          }
          b.appendChild(wrap);
          log.scrollTop = log.scrollHeight;
        }
      } else {
        addBubble("No se pudo procesar la respuesta.", "assistant");
      }
    } catch(err){
      typing.remove();
      addBubble("Error de red. Intenta de nuevo.", "assistant");
    } finally {
      input.disabled = false; sendBtn.disabled = false; input.focus();
    }
  });

  /* ---------- Inicializa el saludo al cargar ---------- */
  document.addEventListener("DOMContentLoaded", ()=> initGreetingIfNeeded());
})();
</script>
