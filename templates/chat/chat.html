<!--
Autor: Maria Clara Medina Gomez
Proyecto: BloomBerry
Archivo: templates/chat.html
Descripción: Layout del chat del chatbot del sitio 
-->
{% extends "base.html" %}
{% load static i18n %}

{% block content %}
<div class="container my-4">
  <h2>Asistente BloomBerry</h2>

  <div id="chat" class="border rounded p-3" style="height:60vh; overflow-y:auto;">
    {% for m in messages %}
      <div class="p-2 my-2 {% if m.role == 'user' %}bg-light text-end{% else %}bg-white border{% endif %}">
        {% if m.role != 'user' %}<div class="text-muted small mb-1">Asistente</div>{% endif %}
        <div>{{ m.content|linebreaksbr }}</div>
      </div>
    {% empty %}
      <div class="text-muted"> ¡Hola! Cuéntame tu tipo de piel, objetivos y presupuesto.</div>
    {% endfor %}
  </div>

  <form id="chat-form" method="post" action="{% url 'chat:send_message' %}" class="d-flex gap-2 mt-3">
    {% csrf_token %}
    <input id="msg" type="text" name="message" class="form-control" placeholder="Escribe tu duda…">
    <button class="btn btn-primary" type="submit">Enviar</button>
  </form>
</div>

<script>
function getCookie(name){const v=`; ${document.cookie}`.split(`; ${name}=`);if(v.length===2) return v.pop().split(';').shift();}
const csrftoken=getCookie('csrftoken');
const chat=document.getElementById("chat");
const form=document.getElementById("chat-form");
const input=document.getElementById("msg");

function addBubble(text, who){
  const b=document.createElement("div");
  b.className="p-2 my-2 "+(who==="user"?"bg-light text-end":"bg-white border");
  if(who!=="user"){const h=document.createElement("div");h.className="text-muted small mb-1";h.textContent="Asistente";b.appendChild(h);}
  const d=document.createElement("div");d.innerHTML=text.replace(/\n/g,"<br>");b.appendChild(d);
  chat.appendChild(b); chat.scrollTop=chat.scrollHeight;
}

form.addEventListener("submit", async e=>{
  e.preventDefault();
  const text=input.value.trim(); if(!text) return;
  addBubble(text,"user"); input.value="";
  try{
    const r=await fetch(form.action,{method:"POST",headers:{"X-CSRFToken":csrftoken,"X-Requested-With":"XMLHttpRequest"},body:new URLSearchParams({message:text})});
    const data=await r.json();
    if(data.ok) addBubble(data.reply,"assistant"); else addBubble("Hubo un error al procesar tu mensaje.","assistant");
  }catch{ addBubble("Error de red. Intenta de nuevo.","assistant"); }
});
</script>
{% endblock %}
